---
title: "ITS2 worldflora"
author: "Bailie Wynbelt"
date: "2023-02-23"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Install and load required packages
```{r install packages}
library(WorldFlora)
library(tidyverse)
```

Download and remember WFO data 
```{r WFO remember}
#WFO.download
WFO.remember(WFO.file = "classification.csv")
```

Read in ITS2 data 
```{r read data}
ITS2_plants <- read_csv("../data/sequenced/ITS2_reads_WeeTU.csv")
```

Find name issues in ITS2 data - this includes species with Authorship or other rows with strange names
```{r create csv of bad names}
ITS2_name_issues <- ITS2_plants %>% 
   distinct(Species) %>% 
   mutate(Species = str_replace_all(Species, "_", " ")) %>% 
   mutate(n_words = str_count(Species, "\\w+")) %>% 
   filter(n_words > 2)

write_csv(ITS2_name_issues, "../outputs/naming_issues/ITS2_name_issues.csv")
```

Replace "_" with a space with gsub - see comment below
```{r gsub}
#not required to run but here for another example of how to replace characters
ITS2_plants$Species <- gsub("_"," ", ITS2_plants$Species)
```

Remove names that are not essential based on ITS2_name_issues.csv file
```{r remove nonessential names}
ITS2_plants <- ITS2_plants %>%
  filter(Species != "Cloning vector pOmni",
         Species != "Rafinesquia environmental sample",
         Species != "embryophyte environmental sample",
         Species != "synthetic construct")

```

Fix naming issues - see comment below
```{r fix bad names}
#do not run - here just to keep - old code
ITS2_plants <- ITS2_plants %>% 
  mutate(Species = str_replace_all(Species, "_", " ")) %>% 
  mutate(Species = replace(Species, Species == "Croton sp. BWvE-2009", "Croton sp."), 
         Species = replace(Species, Species == "Marina sp. Lavin 5341", "Marina sp."),
         Species = replace(Species, Species == "Hebecarpa cf. barbeyana Abbott 14637", "Hebecarpa sp."),
         Species = replace(Species, Species == "Helichrysum sp. Vitek 02350", "Helichrysum sp."),
         Species = replace(Species, Species == "Parakeelya sp. AQ743890", "Parakeelya sp."),
         Species = replace(Species, Species == "Lupinus sp. AT-2012", "Lupinus sp."),
         Species = replace(Species, Species == "Plantago sp. PLANT", "Plantago sp."),
         Species = replace(Species, Species == "Opuntia cf. laevis FOS-2017", "Opuntia sp."),
         Species = replace(Species, Species == "Echinocactus sp. MS-2016", "Echinocactus sp."))
```

Replace names only identified to species level with an "NA" in the "Species" column
```{r fix bad names}
ITS2_plants <- ITS2_plants %>% 
  mutate(Species = str_replace_all(Species, "_", " ")) %>% 
  mutate(Species = replace(Species, Species == "Croton sp. BWvE-2009", "NA"), 
         Species = replace(Species, Species == "Marina sp. Lavin 5341", "NA"),
         Species = replace(Species, Species == "Hebecarpa cf. barbeyana Abbott 14637", "NA"),
         Species = replace(Species, Species == "Helichrysum sp. Vitek 02350", "NA"),
         Species = replace(Species, Species == "Parakeelya sp. AQ743890", "NA"),
         Species = replace(Species, Species == "Lupinus sp. AT-2012", "NA"),
         Species = replace(Species, Species == "Plantago sp. PLANT", "NA"),
         Species = replace(Species, Species == "Opuntia cf. laevis FOS-2017", "NA"),
         Species = replace(Species, Species == "Echinocactus sp. MS-2016", "NA"))
```

Select only the distinct values in the Species column, and remove NA's for WFO.match()
```{r manipulate data}
ITS2_plant_species <- ITS2_plants %>% 
  select(Species) %>% 
  distinct() %>% 
  filter(Species != "NA")

```

Convert to data frame so WFO.match can run properly
```{r convert to data frame}
# need to convert ITS2_plant_species from a tibble to a dataframe
ITS2_plant_species <- as.data.frame(ITS2_plant_species)
```

Match ITS2 data with WFO data
```{r WFO match}
ITS2_plants_match <- WFO.match(spec.data = ITS2_plant_species, 
                               WFO.data = WFO.data,
                               spec.name = 'Species', 
                               Authorship = '', 
                               First.dist = TRUE, 
                               Fuzzy.min = TRUE, 
                               Fuzzy = 0.1, 
                               Fuzzy.max = 250, 
                               Fuzzy.two = TRUE, 
                               Fuzzy.one = TRUE, 
                               squish = TRUE, 
                               spec.name.tolower = FALSE, 
                               spec.name.nonumber = TRUE, 
                               spec.name.nobrackets = TRUE, 
                               exclude.infraspecific = FALSE, 
                               verbose = TRUE, 
                               counter = 1000)
```

Select plants that had fuzzy values and select needed columns from WFO.match data output
```{r select data}
fuzzy_plants_ITS2 <- ITS2_plants_match %>% 
  filter(Fuzzy == 'TRUE') %>% 
  select(Fuzzy,
         Old.name,
         family,
         genus,
         Species,
         scientificName, 
         taxonID,
         taxonomicStatus,
         New.accepted)

```

Remove rows that are not needed (This is here if there are any strange fuzzy matches from WFO)
```{r row removal}
#split into two columns
fuzzy_plants_ITS2 <- fuzzy_plants_ITS2 %>% 
  separate(Species, c('Species', 'Specific.epithet'))


#remove rows from specific epithet column that are not needed
fuzzy_plants_ITS2 <- fuzzy_plants_ITS2 %>% 
  filter(Specific.epithet != "Chitalpa")


#combine species and specific epithet columns, fix formatting of Species column and data frame
fuzzy_plants_ITS2 <- fuzzy_plants_ITS2 %>% 
  unite(Species, Species, Specific.epithet) %>% 
  mutate(Species = str_replace_all(Species, "_", " ")) 
  
```

Add updated names to ITS2 data with a left join
```{r update ITS2 file}
updated_ITS2 <- ITS2_plants %>% 
  left_join(fuzzy_plants_ITS2, by = "Species") 
```

Rename columns and deselect unneeded columns
```{r rename columns}
updated_ITS2 <- updated_ITS2 %>% 
  rename(updated.Name = scientificName) %>% 
  rename(updated.genus = genus) %>% 
  rename(updated.family = family) %>% 
  select(-c(Fuzzy, Old.name, taxonomicStatus)) %>% 
  distinct() 
```

Replace old names, genus, and family with new names in ITS2 file using ifelse statement
```{r replace names}
final_updated_ITS2 <- updated_ITS2 %>% 
  mutate(Species = if_else(!is.na(updated.Name),
                           true = updated.Name,
                           false = Species)) %>% 
  mutate(Genus = if_else(!is.na(updated.genus),
                           true = updated.genus,
                           false = Genus)) %>% 
  mutate(Family = if_else(!is.na(updated.family),
                          true = updated.family,
                          false = Family))
```

For species that updated to only be identified at Genus level, change species column to NA
```{r}
final_updated_ITS2 <- final_updated_ITS2 %>% 
  mutate(Species = replace(Species, Species == "Hypertelis", "NA"),
         Species = replace(Species, Species == "Streblus", "NA"))
```

Quality check to make sure it worked! 
```{r quality check}
final_updated_ITS2 %>% 
  filter(Species == "Salsola kali")

final_updated_ITS2 %>% 
  filter(Species == "Astragalus palenae")

```

Recreate WTUs
```{r}
# Add WeeTUs for Summarizing
# https://dplyr.tidyverse.org/reference/group_data.html


updated_ITS2_reads_WeeTU <- final_updated_ITS2 %>% 
  mutate(WTU.domain = group_indices(., Domain),
         WTU.clade1 = group_indices(., Domain, Clade1),
         WTU.class = group_indices(., Domain, Clade1, Class),
         WTU.order = group_indices(., Domain, Clade1, Class, Order),
         WTU.family = group_indices(., Domain, Clade1, Class, Order, Family),
         WTU.genus = group_indices(., Domain, Clade1, Class, Order, 
                                   Family, Genus),
         WTU.species = group_indices(., Domain, Clade1, Class, Order, Family, 
                                     Genus, Species))

updated_ITS2_reads_WeeTU %>% 
  filter(Species == "Salsola kali")

#write_csv(taxa_data_ITS2, "Data/SequencedData/Plants/ProcessedData/ITS2_reads_WeeTU.csv")
```

Save final data frame as a csv to outputs folder
```{r save as csv}
updated_ITS2_reads_WeeTU <- updated_ITS2_reads_WeeTU %>% 
  select(-c(updated.family, updated.genus, updated.Name, New.accepted))

write_csv(updated_ITS2_reads_WeeTU, "../outputs/updated_ITS2_reads_WeeTU.csv")
```
