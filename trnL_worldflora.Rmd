---
title: "trnL worldflora"
author: "Bailie Wynbelt"
date: "2023-02-22"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Install and load packages
```{r load packages}
library(WorldFlora)
library(tidyverse)
```

Download and remember data set
```{r WFO remember}
#WFO.download()
WFO.remember(WFO.file = "classification.csv")
```

Read in trnL data
```{r read data}
trnL_plants <- read_csv("data/trnL_reads_WeeTU.csv")
```

Find name issues in trnL data
```{r create csv of bad names}
trnL_name_issues <- trnL_plants %>% 
   distinct(Species) %>% 
   mutate(Species = str_replace_all(Species, "_", " ")) %>% 
   mutate(n_words = str_count(Species, "\\w+")) %>% 
   filter(n_words > 2)

write_csv(trnL_name_issues, "data/trnL_name_issues.csv")
```

Replace "_" with a space with gsub
```{r gsub}
#not required to run but here for another example of how to replace characters
trnL_plants$Species <- gsub("_"," ", trnL_plants$Species)
```

Fix naming issues
```{r fix bad names}
trnL_plants <- trnL_plants %>% 
  mutate(Species = str_replace_all(Species, "_", " ")) %>% 
  mutate(Species = replace(Species, Species == "Chamaecrista sp  ASC-2009", "Chamaecrista sp."), #NA
         Species = replace(Species, Species == "Setaria sp  TRK-2015", "Setaria sp."),
         Species = replace(Species, Species == "Sanango sp  Bremer 3352", "Sanango sp."),
         Species = replace(Species, Species == "Helichrysum sp  TRK-2015", "Helichrysum sp."),
         Species = replace(Species, Species == "Taraxacum sect  Naevosa sp  6281f", "Taraxacum (sect Naevosa) sp."),
         Species = replace(Species, Species == "Muehlenbeckia sp  Mt Brockman L A Craven 2357 K L Wilson & Makinson", "Muehlenbeckia sp."),
         Species = replace(Species, Species == "Sida sp  TRK-2015", "Sida sp."),
         Species = replace(Species, Species == "Eragrostis sp  TRK-2015", "Eragrostis sp."),
         Species = replace(Species, Species == "Dypsis sp  Mada25", "Dypsis sp."),
         Species = replace(Species, Species == "Quercus sp  MES114", "Quercus sp."),
         Species = replace(Species, Species == "Ichnanthus sp  Silva et al  550", "Ichnanthus sp."),
         Species = replace(Species, Species == "Juniperus hybrid sp  LO-2009", "Juniperus sp."),
         Species = replace(Species, Species == "Solanum sp  TRK-2015", "Solanum sp."),
         Species = replace(Species, Species == "Pavonia sp  TRK-2015", "Pavonia sp."),
         Species = replace(Species, Species == "Asteraceae sp  TRK-2015", "Asteraceae sp."),
         Species = replace(Species, Species == "Zygia sp  KGD-2009", "Zygia sp."),
         Species = replace(Species, Species == "Hildaea sp  Costa et al  903", "Hildaea sp."),
         Species = replace(Species, Species == "Gazania sp  Koekemoer and Funk 1929", "Gazania sp."),
         Species = replace(Species, Species == "Digitaria sp  TRK-2015", "Digitaria sp."),
         Species = replace(Species, Species == "Celtis sp  Mada221", "Celtis sp."),
         Species = replace(Species, Species == "Nicotiana sp  'rastroensis'", "Nicotiana sp."),
         Species = replace(Species, Species == "Castanopsis sp  'kuchugouzhui'", "Castanopsis sp."),
         Species = replace(Species, Species == "Asteroideae sp  D3-001", "Asteroideae sp."),
         Species = replace(Species, Species == "Operculina sp  Romero 1701", "Operculina sp."),
         Species = replace(Species, Species == "Musa sp  Ogasawara06", "Musa sp."),
         Species = replace(Species, Species == "Pithecellobium sp  DS14533 JM1598", "Pithecellobium sp."),
         Species = replace(Species, Species == "Excoecaria sp  Pell 678", "Excoecaria sp."),
         Species = replace(Species, Species == "Enneapogon sp  TRK-2015", "Enneapogon sp."),
         Species = replace(Species, Species == "Phyllarthron sp  Mada29", "Phyllarthron sp."),
         Species = replace(Species, Species == "Catalpa aff  speciosa Olmstead 88-003", "Catalpa sp."),
         Species = replace(Species, Species == "Piresia sp  Hodkinson 601", "Piresia sp."),
         Species = replace(Species, Species == "Calliandra sp  ERS-2013", "Calliandra sp."),
         Species = replace(Species, Species == "Sclerophylax sp  Nee and Bohs 50857", "Sclerophylax sp."))

```

Replace species names with NA's
```{r}
trnL_plants <- trnL_plants %>% 
  mutate(Species = str_replace_all(Species, "_", " ")) %>% 
  mutate(Species = replace(Species, Species == "Chamaecrista sp  ASC-2009", "NA"),
         Species = replace(Species, Species == "Setaria sp  TRK-2015", "NA"),
         Species = replace(Species, Species == "Sanango sp  Bremer 3352", "NA"),
         Species = replace(Species, Species == "Helichrysum sp  TRK-2015", "NA"),
         Species = replace(Species, Species == "Taraxacum sect  Naevosa sp  6281f", "NA"),
         Species = replace(Species, Species == "Muehlenbeckia sp  Mt Brockman L A Craven 2357 K L Wilson & Makinson", "NA"),
         Species = replace(Species, Species == "Sida sp  TRK-2015", "NA"),
         Species = replace(Species, Species == "Eragrostis sp  TRK-2015", "NA"),
         Species = replace(Species, Species == "Dypsis sp  Mada25", "NA"),
         Species = replace(Species, Species == "Quercus sp  MES114", "NA"),
         Species = replace(Species, Species == "Ichnanthus sp  Silva et al  550", "NA"),
         Species = replace(Species, Species == "Juniperus hybrid sp  LO-2009", "NA"),
         Species = replace(Species, Species == "Solanum sp  TRK-2015", "NA"),
         Species = replace(Species, Species == "Pavonia sp  TRK-2015", "NA"),
         Species = replace(Species, Species == "Asteraceae sp  TRK-2015", "NA"),
         Species = replace(Species, Species == "Zygia sp  KGD-2009", "NA"),
         Species = replace(Species, Species == "Hildaea sp  Costa et al  903", "NA"),
         Species = replace(Species, Species == "Gazania sp  Koekemoer and Funk 1929", "NA"),
         Species = replace(Species, Species == "Digitaria sp  TRK-2015", "NA"),
         Species = replace(Species, Species == "Celtis sp  Mada221", "NA"),
         Species = replace(Species, Species == "Nicotiana sp  'rastroensis'", "NA"),
         Species = replace(Species, Species == "Castanopsis sp  'kuchugouzhui'", "NA"),
         Species = replace(Species, Species == "Asteroideae sp  D3-001", "NA"),
         Species = replace(Species, Species == "Operculina sp  Romero 1701", "NA"),
         Species = replace(Species, Species == "Musa sp  Ogasawara06", "NA"),
         Species = replace(Species, Species == "Pithecellobium sp  DS14533 JM1598", "NA"),
         Species = replace(Species, Species == "Excoecaria sp  Pell 678", "NA"),
         Species = replace(Species, Species == "Enneapogon sp  TRK-2015", "NA"),
         Species = replace(Species, Species == "Phyllarthron sp  Mada29", "NA"),
         Species = replace(Species, Species == "Catalpa aff  speciosa Olmstead 88-003", "NA"),
         Species = replace(Species, Species == "Piresia sp  Hodkinson 601", "NA"),
         Species = replace(Species, Species == "Calliandra sp  ERS-2013", "NA"),
         Species = replace(Species, Species == "Sclerophylax sp  Nee and Bohs 50857", "NA"))

```

Select needed data for WFO.match() and convert to dataframe
```{r manipulate data}
trnL_plant_species <- trnL_plants %>% 
  filter(Species != "fossil Castanea pollen",
         Species != "NA") %>% 
  select(Species) %>% 
  distinct()

# need to convert trnL_plant_species from a tibble to a dataframe
trnL_plant_species <- as.data.frame(trnL_plant_species)

```

Match trnL data with WFO data
```{r WFO match}
trnL_plant_match <- WFO.match(spec.data = trnL_plant_species, 
                               WFO.data = WFO.data,
                               spec.name = "Species", 
                               Authorship = '', 
                               First.dist = TRUE, 
                               Fuzzy.min = TRUE, 
                               Fuzzy = 0.1, 
                               Fuzzy.max = 250, 
                               Fuzzy.two = TRUE, 
                               Fuzzy.one = TRUE, 
                               squish = TRUE, 
                               spec.name.tolower = FALSE, 
                               spec.name.nonumber = TRUE, 
                               spec.name.nobrackets = TRUE, 
                               exclude.infraspecific = FALSE, 
                               verbose = TRUE, 
                               counter = 1000)

# write_csv(trnL_plant_match, "data/trnL_plant_matches.csv")
```

Select plants that had fuzzy values and select needed columns
```{r select data}
fuzzy_plants_trnL <- trnL_plant_match %>% 
  filter(Fuzzy == 'TRUE') %>% 
  select(Fuzzy,
         Old.name,
         family,
         genus,
         Species,
         scientificName, 
         taxonID,
         taxonomicStatus,
         New.accepted)
```

Remove rows that are not needed 
```{r row removal}
fuzzy_plants_trnL <- fuzzy_plants_trnL %>% 
  mutate(scientificName = replace(scientificName, scientificName == "Diplotaxis erucoides  subsp. cossoniana", "Diplotaxis erucoides")) %>% 
  distinct(scientificName, .keep_all = TRUE)

```

Add updated names to trnL data
```{r update trnL file}
updated_trnL <- trnL_plants %>% 
  left_join(fuzzy_plants_trnL, by = "Species") 

updated_trnL <- updated_trnL %>% 
  rename(updated.Name = scientificName) %>% 
  rename(updated.genus = genus) %>% 
  rename(updated.family = family) %>% 
  select(-c(Fuzzy, Old.name, taxonomicStatus)) %>% 
  distinct() 
```

Replace old names with new names in trnL file
```{r replace names}
final_updated_trnL <- updated_trnL %>% 
  mutate(Species = if_else(!is.na(updated.Name),
                           true = updated.Name,
                           false = Species)) %>% 
  mutate(Genus = if_else(!is.na(updated.genus),
                           true = updated.genus,
                           false = Genus)) %>% 
  mutate(Family = if_else(!is.na(updated.family),
                          true = updated.family,
                          false = Family))
```

Quality check to make sure it worked! 
```{r quality check}
final_updated_trnL %>% 
  filter(Species == "Poa serpana")

final_updated_trnL %>% 
  filter(Species == "Lycium bridgesii")

```



Recreate WTUs
```{r}
# Add WeeTUs for Summarizing
# https://dplyr.tidyverse.org/reference/group_data.html
updated_trnL_reads_WeeTU <- final_updated_trnL %>% 
  mutate(WTU.kingdom = group_indices(., Kingdom),
         WTU.clade1 = group_indices(., Kingdom, Clade1),
         WTU.clade2 = group_indices(., Kingdom, Clade1, Clade2),
         WTU.order = group_indices(., Kingdom, Clade1, Clade2, Order),
         WTU.family = group_indices(., Kingdom, Clade1, Clade2, Order, Family),
         WTU.subfamily = group_indices(., Kingdom, Clade1, Clade2, Order, 
                                       Family, Subfamily),
         WTU.genus = group_indices(., Kingdom, Clade1, Clade2, Order, Family, 
                                   Subfamily, Genus),
         WTU.species = group_indices(., Kingdom, Clade1, Clade2, Order, Family, 
                                     Subfamily, Genus, Species))

#write_csv(taxa_data_trnL, "Data/SequencedData/Plants/ProcessedData/trnL_reads_WeeTU.csv")
```

Save final dataframe as a csv
```{r save as csv}
write_csv(final_updated_trnL, "data/updated_trnL_reads_WeeTU.csv")
```
