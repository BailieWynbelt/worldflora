---
title: "trnL worldflora"
author: "Bailie Wynbelt"
date: "2023-02-22"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Install and load packages
```{r load packages}
library(WorldFlora)
library(tidyverse)
```

Download and remember data set
```{r WFO remember}
#WFO.download()
WFO.remember(WFO.file = "classification.csv")
```

Read in trnL data and mutate species column
```{r read data}
trnL_plants <- read_csv("data/trnL_reads_WeeTU.csv")

trnL_plants <- trnL_plants %>% 
  mutate(Species = str_replace_all(Species, "_", " ")) %>% 
  mutate(Species = str_replace_all(Species,"^(\\S*\\s+\\S+).*", "\\1"))
```

Replace "_" with a space with gsub
```{r gsub}
#not required to run but here for another example of how to replace characters
trnL_plants$Species <- gsub("_"," ", trnL_plants$Species)
```

Select needed data for WFO.match() and convert to dataframe
```{r manipulate data}
trnL_plant_species <- trnL_plants %>% 
  select(Species) %>% 
  distinct()

# need to convert trnL_plant_species from a tibble to a dataframe
trnL_plant_species <- as.data.frame(trnL_plant_species)

```

Match trnL data with WFO data
```{r WFO match}
trnL_plant_match <- WFO.match(spec.data = trnL_plant_species, 
                               WFO.data = WFO.data,
                               spec.name = "Species", 
                               Authorship = '', 
                               First.dist = TRUE, 
                               Fuzzy.min = TRUE, 
                               Fuzzy = 0.1, 
                               Fuzzy.max = 250, 
                               Fuzzy.two = TRUE, 
                               Fuzzy.one = TRUE, 
                               squish = TRUE, 
                               spec.name.tolower = FALSE, 
                               spec.name.nonumber = TRUE, 
                               spec.name.nobrackets = TRUE, 
                               exclude.infraspecific = FALSE, 
                               verbose = TRUE, 
                               counter = 1000)

# write_csv(trnL_plant_match, "data/trnL_plant_matches.csv")
```

Select plants that had fuzzy values and select needed columns
```{r Select data}
fuzzy_plants_trnL <- trnL_plants_match %>% 
  filter(Fuzzy == 'TRUE') %>% 
  select(Fuzzy,
         Old.name,
         Species,
         scientificName, 
         taxonID,
         taxonomicStatus,
         New.accepted)
```

Remove rows that are not needed 
```{r row removal}
#split into two columns
fuzzy_plants_trnL <- fuzzy_plants_trnL %>% 
  separate(Species, c('Species', 'Specific.epithet'))


#remove rows from specific epithet column that are not needed
fuzzy_plants_trnL<- fuzzy_plants_trnL %>% 
  filter(Specific.epithet != "sp",
         Specific.epithet != "Castanea",
         Specific.epithet != "aff",
         Specific.epithet != "hybrid")

#combine species and specific epithet columns, fix formatting of Species column and data frame
fuzzy_plants_trnL<- fuzzy_plants_trnL %>% 
  unite(Species, Species, Specific.epithet) %>% 
  mutate(Species = str_replace_all(Species, "_", " ")) 
  
```

Add updated names to trnL data
```{r update trnL file}
updated_trnL <- trnL_plants %>% 
  left_join(fuzzy_plants_trnL, by = "Species") 

updated_trnL <- updated_trnL %>% 
  rename(updated.Name = scientificName) %>% 
  select(-c(Fuzzy, Old.name, taxonomicStatus)) %>% 
  distinct() 
```

Replace old names with new names in trnL file
```{r replace names}
final_updated_trnL<- updated_trnL %>% 
  mutate(Species = if_else(!is.na(updated.Name),
                           true = updated.Name,
                           false = Species))
```

Quality check to make sure it worked! 
```{r quality check}
final_updated_trnL %>% 
  filter(Species == "Poa serpana")
```

Save final dataframe as a csv
```{r save as csv}


```